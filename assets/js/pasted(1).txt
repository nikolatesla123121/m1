<!-- ALBAMEN WIDGET CONTAINER -->
<div class="albamen-widget-container flex flex-col gap-4 max-w-md mx-auto p-4">

    <!-- 1. ĞšĞĞĞŸĞšĞ Ğ¢Ğ•ĞšĞ¡Ğ¢ĞĞ’ĞĞ“Ğ Ğ§ĞĞ¢Ğ (Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ°Ñ) -->
    <!-- ĞĞ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ²Ğ¾Ñ ÑÑ‚Ğ°Ñ€ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ openTextChat() -->
    <div onclick="openTextChat()" class="cursor-pointer group relative bg-slate-800 rounded-2xl p-1 shadow-lg hover:shadow-2xl transition-all duration-300 border border-slate-600 hover:border-blue-400">
        <div class="flex items-center gap-4 bg-slate-900 rounded-xl p-4">
            <!-- ĞĞ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ° (Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° ÑĞ²Ğ¾Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºÑƒ) -->
            <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-blue-500 shadow-lg">
                <img src="https://albaspace.com.tr/assets/img/albamen-face.png" alt="Albamen" class="w-full h-full object-cover"> 
            </div>
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg">Albamen ile YazÄ±ÅŸ</h3>
                <p class="text-slate-400 text-sm">SorularÄ±nÄ± yazarak sor ğŸ“</p>
            </div>
            <div class="text-blue-400 text-2xl group-hover:translate-x-1 transition">â†’</div>
        </div>
    </div>

    <!-- 2. ĞšĞĞĞŸĞšĞ Ğ“ĞĞ›ĞĞ¡ĞĞ’ĞĞ“Ğ Ğ§ĞĞ¢Ğ (ĞĞ¾Ğ²Ğ°Ñ) -->
    <div id="voiceBtnContainer" onclick="toggleVoiceSession()" class="cursor-pointer group relative bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-1 shadow-lg hover:shadow-2xl transition-all duration-300 border border-blue-500/30 hover:border-red-500/50">
        <div class="flex items-center gap-4 bg-slate-900/90 rounded-xl p-4 backdrop-blur-sm">
            <!-- Ğ˜ĞºĞ¾Ğ½ĞºĞ° Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ° -->
            <div id="micIconStatus" class="w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center text-3xl shadow-lg transition-all">
                ğŸ™ï¸
            </div>
            
            <div class="flex-1">
                <h3 class="text-white font-bold text-lg">CanlÄ± Sesli Sohbet</h3>
                <p id="voiceStatusText" class="text-slate-400 text-sm">TÄ±kla ve KonuÅŸ (Live) ğŸ”Š</p>
            </div>
            
            <!-- ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¾Ğ»Ğ½Ñ‹ (ÑĞºÑ€Ñ‹Ñ‚Ğ° Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ) -->
            <div id="voiceWave" class="hidden flex gap-1 items-center h-8">
                <div class="w-1 h-3 bg-red-500 animate-pulse"></div>
                <div class="w-1 h-6 bg-red-500 animate-pulse delay-75"></div>
                <div class="w-1 h-4 bg-red-500 animate-pulse delay-150"></div>
            </div>
        </div>
    </div>

    <!-- ĞœĞĞ”ĞĞ›Ğ¬ĞĞĞ• ĞĞšĞĞ: Ğ’Ğ²Ğ¾Ğ´ Ğ˜Ğ¼ĞµĞ½Ğ¸ (Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸) -->
    <div id="authModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-600">
            <h3 class="text-xl text-white font-bold mb-2 text-center">TanÄ±ÅŸalÄ±m! ğŸ‘‹</h3>
            <p class="text-slate-400 text-sm text-center mb-4">Albamen seninle daha iyi konuÅŸmak iÃ§in adÄ±nÄ± bilmek istiyor.</p>
            
            <input type="text" id="userNameInput" placeholder="AdÄ±n ne?" class="w-full mb-3 p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 outline-none">
            <input type="number" id="userAgeInput" placeholder="YaÅŸÄ±n kaÃ§?" class="w-full mb-4 p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 outline-none">
            
            <div class="flex gap-2">
                <button onclick="closeAuthModal()" class="flex-1 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500">Ä°ptal</button>
                <button onclick="saveAndStartVoice()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 font-bold">BaÅŸla ğŸš€</button>
            </div>
        </div>
    </div>

</div>

<!-- Ğ¡ĞšĞ Ğ˜ĞŸĞ¢Ğ« (LOGIC) -->
<script>
    // === 1. ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ ===
    // Ğ’ÑÑ‚Ğ°Ğ²ÑŒ ÑÑĞ´Ğ° URL ÑĞ²Ğ¾ĞµĞ³Ğ¾ ĞĞĞ’ĞĞ“Ğ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° (worker_live_audio.js)
    const VOICE_WORKER_URL = "wss://albamen-voice.YOUR-SUBDOMAIN.workers.dev"; 

    // === 2. Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ¢Ğ•ĞšĞ¡Ğ¢ĞĞ’ĞĞ“Ğ Ğ§ĞĞ¢Ğ ===
    function openTextChat() {
        // Ğ¡ÑĞ´Ğ° Ğ²ÑÑ‚Ğ°Ğ²ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ñ‚Ğ²Ğ¾ĞµĞ³Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
        // ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: document.getElementById('chat-widget').style.display = 'block';
        alert("Burada eski mesajlaÅŸma botu aÃ§Ä±lacak."); 
    }

    // === 3. Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ“ĞĞ›ĞĞ¡ĞĞ’ĞĞ“Ğ Ğ§ĞĞ¢Ğ ===
    let audioContext = null;
    let websocket = null;
    let isVoiceActive = false;
    let processor = null;
    let inputSource = null;

    // UI ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹
    const micIconStatus = document.getElementById('micIconStatus');
    const voiceStatusText = document.getElementById('voiceStatusText');
    const voiceWave = document.getElementById('voiceWave');
    const authModal = document.getElementById('authModal');

    function toggleVoiceSession() {
        if (isVoiceActive) {
            stopVoiceChat();
        } else {
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ·Ğ½Ğ°ĞµĞ¼ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ¸Ğ¼Ñ
            const name = localStorage.getItem('albamen_userName');
            if (!name) {
                // Ğ•ÑĞ»Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ½ĞµÑ‚ - Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ
                authModal.classList.remove('hidden');
            } else {
                // Ğ•ÑĞ»Ğ¸ Ğ¸Ğ¼Ñ ĞµÑÑ‚ÑŒ - ÑÑ€Ğ°Ğ·Ñƒ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
                startVoiceChat();
            }
        }
    }

    function closeAuthModal() {
        authModal.classList.add('hidden');
    }

    function saveAndStartVoice() {
        const name = document.getElementById('userNameInput').value;
        const age = document.getElementById('userAgeInput').value;
        
        if(name) {
            localStorage.setItem('albamen_userName', name);
            localStorage.setItem('albamen_userAge', age);
            closeAuthModal();
            startVoiceChat();
        }
    }

    async function startVoiceChat() {
        try {
            voiceStatusText.innerText = "BaÄŸlanÄ±yor...";
            
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ URL
            const name = localStorage.getItem('albamen_userName') || "";
            const age = localStorage.getItem('albamen_userAge') || "";
            const wsUrl = `${VOICE_WORKER_URL}?name=${encodeURIComponent(name)}&age=${encodeURIComponent(age)}`;

            // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°ÑƒĞ´Ğ¸Ğ¾
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            
            websocket = new WebSocket(wsUrl);

            websocket.onopen = async () => {
                isVoiceActive = true;
                updateUI(true);
                await startMicrophone();
            };

            websocket.onmessage = async (event) => {
                const response = JSON.parse(event.data);
                if (response.serverContent?.modelTurn?.parts) {
                    for (const part of response.serverContent.modelTurn.parts) {
                        if (part.inlineData && part.inlineData.mimeType.startsWith('audio/')) {
                            playAudioChunk(part.inlineData.data);
                        }
                    }
                }
            };

            websocket.onclose = () => stopVoiceChat();
            websocket.onerror = () => stopVoiceChat();

        } catch (e) {
            console.error(e);
            stopVoiceChat();
        }
    }

    function stopVoiceChat() {
        isVoiceActive = false;
        if(websocket) websocket.close();
        if(audioContext) audioContext.close();
        if(inputSource) inputSource.disconnect();
        if(processor) processor.disconnect();
        updateUI(false);
    }

    function updateUI(isActive) {
        if (isActive) {
            micIconStatus.classList.remove('bg-blue-600');
            micIconStatus.classList.add('bg-red-600', 'animate-pulse');
            micIconStatus.innerText = "ğŸ›‘";
            voiceStatusText.innerText = "Dinliyorum... KonuÅŸ!";
            voiceWave.classList.remove('hidden');
        } else {
            micIconStatus.classList.add('bg-blue-600');
            micIconStatus.classList.remove('bg-red-600', 'animate-pulse');
            micIconStatus.innerText = "ğŸ™ï¸";
            voiceStatusText.innerText = "TÄ±kla ve KonuÅŸ (Live) ğŸ”Š";
            voiceWave.classList.add('hidden');
        }
    }

    // --- ĞĞ£Ğ”Ğ˜Ğ Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« ---
    async function startMicrophone() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: 24000 } });
        inputSource = audioContext.createMediaStreamSource(stream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = (e) => {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) return;
            const inputData = e.inputBuffer.getChannelData(0);
            // ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² PCM16 Base64
            const pcm16 = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
                let s = Math.max(-1, Math.min(1, inputData[i]));
                pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            
            let binary = '';
            const bytes = new Uint8Array(pcm16.buffer);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            const base64Audio = window.btoa(binary);

            websocket.send(JSON.stringify({
                realtime_input: { media_chunks: [{ mime_type: "audio/pcm", data: base64Audio }] }
            }));
        };

        inputSource.connect(processor);
        processor.connect(audioContext.destination);
    }

    let nextStartTime = 0;
    function playAudioChunk(base64String) {
        const binaryString = window.atob(base64String);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
        const int16Data = new Int16Array(bytes.buffer);
        const float32Data = new Float32Array(int16Data.length);
        for (let i = 0; i < int16Data.length; i++) float32Data[i] = int16Data[i] / 32768.0;

        const buffer = audioContext.createBuffer(1, float32Data.length, 24000);
        buffer.getChannelData(0).set(float32Data);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        const playTime = Math.max(audioContext.currentTime, nextStartTime);
        source.start(playTime);
        nextStartTime = playTime + buffer.duration;
    }
</script>